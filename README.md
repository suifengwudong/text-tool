# 轻墨 - 轻量化小说写作结构化工具

## 项目概述

**轻墨**（暂定名）是一款专为小说创作者打造的轻量化结构化写作工具。它复刻了VS Code的核心UI体验，剔除冗余功能，专注于小说写作的结构化需求。通过Markdown（内容）+ JSON（设计）为核心载体，支持人设/章节图形化调整，预留LLM辅助拓展能力，全程本地运行，无云端依赖。

### 核心目标
- **体验层**：100%复用VS Code的核心UI/交互逻辑（左侧工具栏、树形导航、分栏编辑、快捷键），降低用户学习成本。
- **轻量化**：安装包体积≤8MB，启动时间≤0.5秒，内存占用≤50MB（无浏览器内核/冗余进程）。
- **结构化**：以Markdown+JSON为核心，实现小说内容、人设、章节的结构化管理，适配LLM输入。
- **场景化**：提供小说专属的图形化人设/章节调整、大纲/伏笔管理功能，无编程相关冗余模块。

### 目标用户
小说创作者（侧重结构化写作、适配LLM辅助创作的用户）。

### 设计原则
- **用户侧极致轻量化**：仅保留写作核心功能，剔除插件市场、终端、调试、Git、Copilot等所有冗余模块；仅本地纯文本存储（MD/JSON），无数据库/云端同步。
- **VS Code UI体验复用**：复刻左侧工具栏（图标化切换面板）、树形项目导航、分栏编辑区、快捷键体系（如Ctrl+S保存、Ctrl+/注释）。
- **结构化优先**：所有内容最终落地为Markdown/JSON结构化文本，图形化操作仅为交互层，最终同步到文本文件。
- **小说场景专属**：功能模块仅围绕“内容写作、人设管理、章节调整、大纲伏笔、LLM辅助”设计，无通用编辑冗余功能。
- **本地优先**：所有操作本地完成，无强制联网、数据上传，LLM优先支持本地轻量模型部署。

## 产品架构设计

### 整体架构（分层设计）
- **UI层**：复刻VS Code风格界面，使用egui实现轻量化渲染。
- **交互层**：图形化操作（人设卡片、章节时间轴、大纲树等），与文本层双向同步。
- **数据层**：纯文本存储（Markdown/JSON），支持本地文件操作。
- **拓展层**：LLM辅助接口，支持本地模型部署。

### 核心模块拆解

#### 模块1：小说编辑模块（📝）- 核心写作层
- **项目树形导航**：复刻VS Code项目树，仅显示小说项目目录：Content（MD内容文件）、Design（JSON设计文件）、废稿文件夹；支持折叠/展开、重命名、删除。
- **双分栏编辑区**：左侧Content栏：Markdown编辑（保留VS Code语法高亮、块折叠、快捷键）；右侧Design栏：JSON编辑（自动生成模板，与MD实时联动）。
- **本地文件操作**：新建/保存/导出MD/JSON文件，无自动备份、版本历史（避免冗余）。

#### 模块2：人设&章节模块（👤）- 图形化调整层
- **人设图形化编辑器**：卡片式布局：人物卡片（显示姓名/核心属性），拖拽卡片绘制关系线（敌对/友好/亲属）；编辑卡片属性自动同步到Content/人设.md和Design/人物配置.json。
- **章节时间轴编辑器**：横向时间轴：显示章节节点，点击添加/删除章节，拖拽调整顺序；节点可标注“高潮/伏笔/过渡”，同步到Design/章节结构.json。
- **一键同步**：将图形化调整结果同步到MD/JSON文件，支持反向同步（修改文本后更新图形化界面）。

#### 模块3：大纲&伏笔模块（🧭）- 结构化管理层
- **大纲树形编辑器**：复刻VS Code树形折叠逻辑，拖拽调整大纲层级（卷→章→节→核心情节）；支持折叠/展开，同步到Content/章节大纲.md。
- **伏笔标签管理**：标签式布局：添加伏笔标签（如“伏笔1：XX”），拖拽关联对应章节；支持搜索、筛选，同步到Content/伏笔.md。
- **进度追踪**：极简进度显示：仅展示章节完成度（已写/待写），无冗余统计/分析功能。

#### 模块4：LLM辅助模块（🤖）- 拓展层
- **结构化补全**：读取Content的Markdown层级，调用LLM补全正文/对话/场景描述；结果直接插入编辑区。
- **人设对话优化**：基于图形化人设的属性（性格/背景），优化Content中的人物对话风格。
- **本地模型适配**：支持Llama 2 7B、Phi-2等轻量模型本地部署，无强制联网调用云端API。
- **极简配置**：仅保留“模型选择、温度调节、补全长度”3个配置项，无冗余参数。

## 交互设计

### 整体布局（复刻VS Code核心布局）
```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 顶部菜单栏（极简）：文件/编辑/视图/设置                                     │
├────────┬───────────────────────────────────────────────────────────────────┤
│ 左侧工具栏（图标化）│ 左侧面板（随工具栏切换）                              │ 中央编辑区（双分栏）       │
│ 📝（小说编辑）     │ ┌──────────────────────────────────────────────────┐ │ ┌──────────────┬──────────────┐ │
│ 👤（人设&章节）    │ │ 项目树：Content/Design/废稿                       │ │ │ Content（MD）│ Design（JSON）│ │
│ 🧭（大纲&伏笔）    │ │ （VS Code树形折叠逻辑）                           │ │ │ 编辑区       │ 编辑区       │ │
│ 🤖（LLM辅助）      │ └──────────────────────────────────────────────────┘ │ └──────────────┴──────────────┘ │
│                    │ ┌──────────────────────────────────────────────────┐ │                              │
│                    │ │ 人设卡片+章节时间轴（图形化）                     │ │                              │
│                    │ └──────────────────────────────────────────────────┘ │                              │
│                    │ ┌──────────────────────────────────────────────────┐ │                              │
│                    │ │ 大纲树+伏笔标签（轻量化可视化）                   │ │                              │
│                    │ └──────────────────────────────────────────────────┘ │                              │
│                    │ ┌──────────────────────────────────────────────────┐ │                              │
│                    │ │ LLM辅助配置+功能按钮（极简）                      │ │                              │
│                    │ └──────────────────────────────────────────────────┘ │                              │
└────────┴───────────────────────────────────────────────────────────────────┘
```

### 核心交互规则（复用VS Code习惯）
1. 左侧工具栏：点击图标切换左侧面板，hover显示模块名称（如📝：小说编辑）。
2. 项目树：右键菜单仅保留“新建文件/文件夹、重命名、删除、打开”，无VS Code的“在终端中打开、复制路径”等冗余选项。
3. 编辑区：复用VS Code快捷键（Ctrl+S保存、Ctrl+/注释、Ctrl+Z撤销、Alt+鼠标选中块）；Markdown语法高亮与VS Code一致。
4. 图形化操作：拖拽操作后自动提示“是否同步到文本文件”，无自动同步（避免误操作）。
5. LLM辅助：点击“补全”按钮后，结果插入编辑区光标位置，保留撤销功能。

## 技术选型

### 核心技术栈（用户侧轻量化优先）
- **底层语言&框架**：Rust + egui（极致轻量化，打包体积≤5MB，内存占用极低，支持本地LLM部署）。
- **文本解析引擎**：tree-sitter（MD/JSON结构化解析，轻量、高性能，支持AST解析，适配小说文本的层级/标签提取）。
- **图形化渲染**：egui（轻量化，无冗余动画，内存占用低）。
- **本地存储**：纯文本文件（MD/JSON，无数据库依赖，轻量化，用户可直接用其他编辑器打开）。
- **LLM接口**：llm-rs（支持本地轻量模型部署，适配主流云端API）。

### 轻量化技术要点
1. 编译优化：Rust项目开启release模式，裁剪无用依赖，静态编译。
2. 资源裁剪：仅保留核心图标/样式，无图片/字体冗余，复用系统字体。
3. 进程管控：仅启动主进程，无后台辅助进程。
4. 渲染优化：图形化界面仅渲染当前可视区域，不加载全量数据。

## 轻量化设计细则

- **安装包体积**：≤5MB（Rust+egui方案）；剔除所有第三方UI组件冗余、无用依赖。
- **启动速度**：≤0.5秒；无启动加载动画，直接渲染界面，延迟加载非核心模块。
- **内存占用**：≤50MB（编辑单本10万字小说时）；无内存泄漏，关闭面板后释放对应资源。
- **存储占用**：仅存储MD/JSON纯文本，无缓存文件/日志文件。
- **运行时冗余**：无自动更新、无日志收集、无广告、无弹窗提示（仅必要操作确认）。

## 迭代规划

### 第一阶段：MVP（最小可行产品）- 核心写作层
1. 完成VS Code风格UI复刻：左侧工具栏、项目树、双分栏MD/JSON编辑区。
2. 实现本地MD/JSON文件的新建/保存/编辑功能。
3. 完成轻量化基础：安装包≤5MB，启动≤0.5秒，内存≤50MB。
4. 核心目标：验证“轻量化+VS Code UI+MD/JSON结构化”核心体验。

### 第二阶段：场景化能力 - 图形化调整层
1. 开发人设图形化编辑器（卡片+关系线）、章节时间轴编辑器。
2. 实现图形化操作与MD/JSON的双向同步。
3. 开发大纲树、伏笔标签管理功能。
4. 核心目标：完成小说专属的结构化管理能力。

### 第三阶段：拓展能力 - LLM辅助层
1. 接入本地轻量LLM模型（Llama 2 7B/Phi-2）。
2. 实现结构化补全、人设对话优化功能。
3. 适配主流云端LLM API（可选）。
4. 核心目标：完成LLM与结构化文本的联动。

## 核心验收标准

- **轻量化**：安装包≤5MB，启动≤0.5秒，编辑10万字小说内存≤50MB，无后台冗余进程。
- **VS Code体验**：工具栏/项目树/编辑区交互逻辑与VS Code一致，快捷键复用率≥90%。
- **结构化**：所有图形化操作可同步为MD/JSON文本，文本修改可反向同步到图形化界面。
- **场景化**：支持人设关系调整、章节顺序调整、伏笔管理，无编程相关功能。
- **本地优先**：所有操作本地完成，无强制联网，可离线使用。

## 代码结构

```
src/
├── main.rs                  # 程序入口
└── app/
    ├── mod.rs               # TextToolApp 结构体、核心逻辑（项目/文件/同步操作）及单元测试
    ├── models.rs            # 数据模型（RelationKind、Character、Chapter、Foreshadow、LlmConfig、Panel 等）
    ├── file_manager.rs      # 文件系统结构（FileNode、OutlineEntry、OpenFile）及 rfd 文件对话框封装
    ├── ui_helpers.rs        # 公共 UI 组件（菜单栏、工具栏、状态栏、新建文件对话框、键盘快捷键）
    └── panel/               # 各功能面板 UI（按面板分组）
        ├── mod.rs           # 声明子模块
        ├── novel.rs         # 小说编辑面板（文件树、双分栏编辑区）
        ├── characters.rs    # 人设&章节面板（人物列表、章节时间轴）
        ├── outline.rs       # 大纲&伏笔面板（大纲树、伏笔管理、进度追踪）
        └── llm.rs           # LLM辅助面板（模型配置、提示词输入、输出展示）
```

### 为什么选择目录模块而非单文件？

项目早期将全部逻辑放在一个 `src/app.rs` 中（~1764 行）。随着功能增加，单文件会带来一系列问题，因此改为 `src/app/` 目录模块，并将各面板进一步归入 `src/app/panel/` 子目录。两种方式的对比如下：

| 维度 | 单文件 `src/app.rs` | 目录模块 `src/app/` + `panel/` |
|------|-------------------|-----------------------------|
| **可读性** | 滚动千行才能找到目标函数 | 文件名即功能名，直接打开对应文件 |
| **职责划分** | 数据模型、UI 渲染、文件操作混在一起 | 每个文件只做一件事，边界清晰 |
| **层级结构** | 所有代码平铺 | 面板代码集中在 `panel/`，与公共基础设施分离 |
| **并行开发** | 多人同时改同一文件极易产生 Git 冲突 | 不同面板由不同文件承载，冲突概率大幅降低 |
| **编译速度** | 任何改动都重新编译整个文件 | 只重新编译被修改的子模块 |
| **可测试性** | 测试代码与业务代码堆在一起 | 可在各子模块内独立编写和运行单元测试 |
| **扩展性** | 新增面板/功能需在同一文件里插入代码 | 在 `panel/` 下新增 `xxx.rs` 文件，不影响其他模块 |

> **Rust 说明**：在 Rust 中，`src/app.rs` 与 `src/app/mod.rs` 对外导出的模块名完全相同（都是 `mod app`），调用方无需任何修改。目录形式是官方推荐的大型模块组织方式，两者在语义上等价，仅在文件布局上有区别。

## 安装与使用

### 安装
1. 确保安装了Rust工具链（https://rustup.rs/）。
2. 克隆项目：`git clone https://github.com/suifengwudong/text-tool.git`
3. 进入目录：`cd text-tool`
4. 构建：`cargo build --release`
5. 运行：`cargo run`

### 使用
- 打开项目后，选择小说项目目录。
- 使用左侧工具栏切换模块。
- 在编辑区编写Markdown内容和JSON设计。
- 图形化模块支持拖拽调整，同步到文本文件。

## 贡献
欢迎提交Issue和Pull Request。请遵循项目的设计原则，保持轻量化。

## 许可证
MIT License